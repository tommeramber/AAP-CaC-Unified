---
- name: Manage AAP Configuration
  hosts: localhost
  gather_facts: false
  connection: local
  vars_files:
  - ../group_vars/controller_vars.yaml
  
  tasks:
    - name: "Generate temporary OAuth2 token"
      ansible.controller.token:
        description: "Temp token for config-as-code run"
        scope: "write"
        state: "present"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ ansible_user }}"
        controller_password: "{{ ansible_password }}"
        validate_certs: "{{ controller_validate_certs }}"
      register: temp_token
      no_log: true
      
    - name: Set Controller auth_token for all roles
      set_fact:
        controller_temp_token: "{{ temp_token.ansible_facts.controller_token.token }}" 
      no_log: true

    - block:
      - include_role: { name: deploy_controller_projects }
      - include_role: { name: deploy_controller_execution_envrionments }
      - include_role: { name: deploy_controller_credential_types }

      - include_role: 
          name: deploy_controller_credentials
          vars:
            with_hashi_vault: true #or false

      - include_role: { name: deploy_controller_inventories }
      - include_role: { name: deploy_controller_job_templates }
      
      rescue:
      - debug:
          msg: "Problem with a role"
          
      always:
      - name: "Revoke temporary OAuth2 token"
        ansible.controller.token:
          existing_token_id: "{{ temp_token.ansible_facts.controller_token.id }}"
          state: "absent"
          controller_host: "{{ controller_host }}"
          controller_username: "{{ ansible_user }}"
          controller_password: "{{ ansible_password }}"
          validate_certs: "{{ controller_validate_certs }}"			
        no_log: true
        when: temp_token.ansible_facts.controller_token is defined